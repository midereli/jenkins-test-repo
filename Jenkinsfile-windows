properties([
  parameters([
    choice(
      choices: [
        'Development+Shipping',
        'Development+Test+Shipping',
        'Development',
        'Shipping',
        'Test',
        'DebugGame'
      ],
      description: '''Development = This configuration is equivalent to Release. Unreal Editor uses the Development configuration by default. Compiling your project using the Development configuration enables you to see code changes made to your project reflected in the editor.\n\nShipping =  This is the configuration for optimal performance and shipping your game. This configuration strips out console commands, stats, and profiling tools.\n\nTest =  This configuration is the Shipping configuration, but with some console commands, stats, and profiling tools enabled.\n\nDebugGame = This configuration builds the engine as optimized, but leaves the game code debuggable. This configuration is ideal for debugging only game modules.''',
      name: 'BUILD_CONFIGURATION'
    ),
    string(
      defaultValue: 'Providence',
      description: 'The name of the uproject file.',
      name: 'PROJECT_NAME'
    ),
    booleanParam(
      description: 'Removes the derived data cached folders and some cached data in the Saved folders. Use this if there are visual discrepancies between a local standalone build and the one in Jenkins. For example, some shaders stop working in a Jenkins build.',
      name: 'REMOVE_CACHED_DATA'
    ),
    string(
      defaultValue: 'D:\\Jenkins\\Archive',
      description: 'The path where builds will be archive in the Jenkins agent.',
      name: 'PATH_TO_ARCHIVE'
    ),
    string(
      description: 'update',
      name: 'update'
    ),
    string(
      defaultValue: 'D:\\Jenkins\\temp',
      description: 'The path where temp builds will be generated. From this folder they will be compressed and moved to the Archive folder',
      name: 'PATH_TO_TEMP'
    ),
    booleanParam(
      defaultValue: true,
      description: 'If set to be fast Binaries and Intermediate folders won\'t be deleted. By default this is FALSE as we want to have a clean build.',
      name: 'FAST_BUILD'
    ),
    [
      $class: 'ChoiceParameter', 
      choiceType: 'PT_CHECKBOX',
      description: 'Select the maps to be cooked.',
      filterLength: 1,
      filterable: false,
      name: 'MAPS_TO_COOK',
      script: [
        $class: 'GroovyScript',
        fallbackScript: [
          classpath: [], 
          sandbox: false, 
          script: 'return ["ERROR"]'
        ],
        script: [
          classpath: [], 
          sandbox: false, 
          script: '''
            List maps = []
            new URL("https://jenkins-custom-builds.s3.eu-west-1.amazonaws.com/maps_to_cook.txt").eachLine { line -> maps.add(line)}
            return maps
          '''.stripIndent()
        ]
      ]
    ],
    booleanParam (
      name: 'REMOVE_DEV_FOLDERS_KEY',
      defaultValue: false,
      description: 'Select to remove +DirectoriesToNeverCook key from DefaultGame.ini file.'
    )
  ])
])

pipeline {
  agent any
  environment {
    CREDENTIALS_ID = 'google-storage-test'
    BUCKET = 'testo-jenkins-build-bucket'
    PATTERN = '*.class'
  }
  stages {
    stage('Compile') {
      steps {
        echo 'Compiling...'
        bat 'javac HelloWorld.java'
        bat 'java HelloWorld'
      }
    }
    stage('Customize DefaultGame.ini') {
      steps {
        bat "curl --request POST --data \"{\\\"messages\\\":[\\\"${env.JOB_NAME} ${env.BUILD_NUMBER} My First Message fail\\\",\\\"My Second Message fail\\\"],\\\"url\\\":\\\"http://jenkins.han-dynastystudios.com:8080/job/Han_Binaries_Swarm_Tests/job/Dev-Main/review/build\\\",\\\"status\\\":\\\"fail\\\"}\" ${params.update}"
        echo 'Executing with -findmaps to find Persistent.umap suffixed files under Game/Providence/ and writing them to maps_to_cook.txt file.'
        // bat "ini-customizer -findmaps"
        echo 'Uploading maps_to_cook.txt file to S3.'
        // bat "path"
        bat "\"C:\\Program Files\\Amazon\\AWSCLIV2\\aws.exe\" --version"
        // bat "aws s3 cp maps_to_cook.txt s3://jenkins-custom-builds/maps_to_cook.txt --profile jenkins_s3_user"
        echo 'Editing Game/Providence/Config/DefaultGame.ini file.'
        // bat "ini-customizer -removedevfolderskey=${params.REMOVE_DEV_FOLDERS_KEY} -inipath Game/Providence/Config/DefaultGame.ini -mapstocook ${params.MAPS_TO_COOK}"
      }
    }
    stage('Send notification to Slack') {
      steps {
        echo 'send notification to slack commented for this step'
      }
    }
  }
  post {
    always {
      echo 'pipeline always echoes this message'
    }
    success {
      echo 'pipeline finished successfully'
    }
    failure {
      echo 'job failed'
    }
    cleanup {
      powershell 'echo cleanup'
    }
  }
}